/**!
 * Droparea - Makes an easy and intuitive to upload upload files through drag and drop or select methods.
 * Copyright (c) 2015, Rogério Taques.
 *
 * @requires jQuery v1.11 or above
 * @version 1.0.5
 * @cat Plugins/Image
 * @author Rogério Taques (rogerio.taques@gmail.com)
 * @see https://github.com/rogeriotaques/droparea
 */
(function(d){var f={url:"path/to/server/script",upload:true,file_holder:"#file",file_preview:"#file_preview",notification_delay:5000,accepted:".jpg|.png|.gif",file_max_size:2048,extra_data:[],success:null,i18n:{unable_to_upload:"Unable to upload at this time.<br >Select a file.",wrong_file_type:"Unacceptable file type!<br >Try: %s",wrong_file_size:"Dropped file is too big!<br >Max file size allowed: %s",abort:"Abort",mb:" MB",kb:" KB",percent:"% ",dismiss:"Dismiss",error:"Err: "}},b={init:function(h){return this.each(function(){var k=d(this),i=null,m=null,j=null,l={};l=d.extend({},f,h);if(d(l.file_holder).length&&d(l.file_preview).length){d(l.file_holder).on("change",function(p){var n=new FileReader();n.readAsDataURL(d(this)[0].files[0]);n.onload=function(q){d(l.file_preview).animate({opacity:0},"slow",function(){d(this).attr("src",q.target.result).animate({opacity:1},"slow");k.find(".statusbar.alert-block").fadeOut("slow",function(){d(this).remove()})})}})}k.parent().css("position",k.parent().css("position"));k.on("click",function(n){n.stopPropagation();n.preventDefault();d(l.file_holder).click()}).on("dragenter",function(n){n.stopPropagation();n.preventDefault();k.addClass("droparea-dragging")}).on("dragleave",function(n){n.stopPropagation();n.preventDefault();k.removeClass("droparea-dragging")}).on("dragover",function(n){n.stopPropagation();n.preventDefault();k.addClass("droparea-dragging")}).on("drop",function(p){p.preventDefault();k.toggleClass("droparea-dropped droparea-dragging");i=p.originalEvent.dataTransfer.files[0];if(!l.upload){c(k,l.i18n.unable_to_upload,true,false);d(l.file_holder).click();return}if(l.accepted!==null&&typeof l.accepted!="boolean"){if(l.accepted.indexOf(i.name.substr(i.name.lastIndexOf(".")))===-1){c(k,l.i18n.wrong_file_type.replace("%s","<b >"+l.accepted.split("|").join("</b> or <b >")+"</b>"));return}}if((i.size/1024)>l.file_max_size){c(k,l.i18n.wrong_file_size.replace("%s","<b >"+l.file_max_size+" "+l.i18n.kb+"</b>"));return}m=new FormData();m.append(l.file_holder.replace("#",""),i);if(l.extra_data!==null){for(var n in l.extra_data){if(d("#"+l.extra_data[n].replace("#","")).length){m.append(l.extra_data[n].replace("#",""),d("#"+l.extra_data[n].replace("#","")).val())}}}j=new e(k,l);j.setFileNameSize(i.name,i.size);g(m,j,k,i,l)})})}},a=0,e=function(h,i){a++;this.statusbar=d('<div class="statusbar statusbar-'+a+'"></div>');this.filename=d('<div class="filename"></div>').appendTo(this.statusbar);this.size=d('<div class="filesize"></div>').appendTo(this.statusbar);this.progressBar=d('<div class="progressbar"><div></div></div>').appendTo(this.statusbar);this.progressBarWidth=0;this.abort=d('<a class="btn abort">'+i.i18n.abort+"</div>").appendTo(this.statusbar);this.statusbar.css({width:h.outerWidth(),height:h.outerHeight(),top:h.offset().top,left:h.offset().left,});h.append(this.statusbar);this.setFileNameSize=function(l,m){var k="",j=(m/1024);if(parseInt(j)>1024){k=(j/1024).toFixed(2)+i.i18n.mb}else{k=j.toFixed(2)+i.i18n.kb}this.filename.html(l);this.size.html(k)};this.setProgress=function(j){this.progressBarWidth=j*this.progressBar.width()/100;this.progressBar.find("div").animate({width:this.progressBarWidth},10).html(j+i.i18n.percent);if(parseInt(j)>=100){this.abort.hide()}};this.setAbort=function(j){this.abort.on("click",function(k){k.preventDefault();j.abort();this.statusbar.hide()})}},c=function(l,m,n,i){n=(typeof n!="undefined"?n:true);i=(typeof i!="undefined"?i:true);var k=d('<div class="statusbar alert-block"></div>'),h=d('<div class="filename"></div>').html(m).appendTo(k),j=d('<button class="btn dismiss"></button>').html(o.i18n.dismiss);k.css({width:l.outerWidth(),height:l.outerHeight(),top:l.offset().top,left:l.offset().left,});l.append(k);if(n){j.on("click",function(p){p.stopPropagation();p.preventDefault();k.fadeOut("fast",function(){d(this).remove()})}).appendTo(k)}if(i){setTimeout(function(){k.fadeOut("fast",function(){d(this).remove()})},o.notification_delay)}},g=function(m,h,k,i,l){var j=d.ajax({xhr:function(){var n=d.ajaxSettings.xhr();if(n.upload){n.upload.addEventListener("progress",function(s){var r=0,p=(s.loaded||s.position),q=s.total;if(s.lengthComputable){r=Math.ceil(p/q*100)}h.setProgress(r)},false)}return n},url:l.url,type:"POST",contentType:false,processData:false,cache:false,data:m,success:function(n){n=d.parseJSON(n);h.setProgress(100);if(l.success!==null&&d.isFunction(l.success)){l.success(n,(typeof n.file_name!="undefined"?n.file_name:null),i)}k.removeClass("droparea-dropped")},error:function(n,q,p){h.progressBar.addClass("droparea-fail");h.progressBar.find("div:first").html(l.i18n.error+p)},complete:function(n,p){setTimeout(function(){h.statusbar.fadeOut("fast",function(){d(this).remove()})},l.notification_delay)}});h.setAbort(j)};d.fn.droparea=function(h){if(b[h]){return b[h].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof h==="object"||!h){return b.init.apply(this,arguments)}else{d.error("Method "+h+" does not exist on jQuery.droparea()")}}}})(jQuery);
